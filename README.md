# Data-Warehouse-via-AWS

## Dataset

The project will be working with two datasets that reside in S3. Here are the S3 links for each:

- Song data: `s3://udacity-dend/song_data`
- Log data: `s3://udacity-dend/log_data`
- Log data json path: `s3://udacity-dend/log_json_path.json`

### Song data

The `Song data` is a subset of real data from the [Million Song Dataset](https://labrosa.ee.columbia.edu/millionsong/). Each file is in JSON format and contains metadata about a song and the artist of that song. The files are partitioned by the first three letters of each song's track ID. For example, here are filepaths to two files in this dataset.

```sh
song_data/A/B/C/TRABCEI128F424C983.json
song_data/A/A/B/TRAABJL12903CDCF1A.json
```

And below is an example of what a single song file, TRAABJL12903CDCF1A.json, looks like.

```python
{
    "num_songs": 1, 
    "artist_id": "ARJIE2Y1187B994AB7", 
    "artist_latitude": null, 
    "artist_longitude": null, 
    "artist_location": "", 
    "artist_name": "Line Renaud", 
    "song_id": "SOUPIRU12A6D4FA1E1", 
    "title": "Der Kleine Dompfaff", 
    "duration": 152.92036, 
    "year": 0
}
```

### Log data

The `Log data` consists of log files in JSON format generated by this event simulator based on the songs in the dataset above. These simulate app activity logs from an imaginary music streaming app based on configuration settings.

The log files in the dataset are partitioned by year and month. For example, here are filepaths to two files in this dataset.

```sh
log_data/2018/11/2018-11-12-events.json
log_data/2018/11/2018-11-13-events.json
```

And the data looks like

```python
{
    "artist":null,
    "auth":"Logged In",
    "firstName":"Walter",
    "gender":"M",
    "itemInSession":0,
    "lastName":"Frye",
    "length":null,
    "level":"free",
    "location":"San Francisco-Oakland-Hayward, CA",
    "method":"GET",
    "page":"Home",
    "registration":1540919166796.0,
    "sessionId":38,
    "song":null,
    "status":200,
    "ts":1541105830796,
    "userAgent":"\"Mozilla\/5.0 (Macintosh; Intel Mac OS X 10_9_4) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/36.0.1985.143 Safari\/537.36\"",
    "userId":"39"
}
```

### Schema for Song Play Analysis

Using the song and log datasets, we create a star schema optimized for queries on song play analysis. The fact and dimension tables are designed as bellow:

![erd](assets/Songplay%20analysis.png)

Fact Table:

- songplays - records in event data associated with song plays i.e. records with page `NextSong`
  - songplay_id, start_time, user_id, level, song_id, artist_id, session_id, location, user_agent

Dimension Tables:

- users - users in the app
  - user_id, first_name, last_name, gender, level
- songs - songs in music database
  - song_id, title, artist_id, year, duration
- artists - artists in music database
  - artist_id, name, location, lattitude, longitude
- time - timestamps of records in songplays broken down into specific units
  - start_time, hour, day, week, month, year, weekday

## Getting Started

1. Create Redshift Cluster on AWS. This step can be done through the AWS console or by running `init/create_cluster.py`. (update the `init/dwh.cfg` file first)
2. Update necessary parameters in `dwh.cfg` file to connect Redshift.
3. Create tables by running `python create_tables.py` in command prompt. To modify the design of the tables and staging area, check `sql_queries.py`.
4. Load data from S3 bucket in staging area and insert them into our fact and dimension tables by running `python etl.py`
5. Explore data and run queries with `analysis.ipynb` open in Jupyter Notebook
6. Delete the cluster through AWS console or by running `init/delete_cluster.py`

## Running the queries

### How many artists are there in the database?

```SQL
SELECT COUNT(DISTINCT artist_id) FROM artists
```

|count|
|:--|
|200|

### What are the top 5 popular songs in the database?

```SQL
SELECT DISTINCT
title, name, time
FROM
(SELECT DISTINCT
song_id, artist_id, COUNT(DISTINCT songplay_id) as time
FROM songplays
GROUP BY song_id, artist_id) t 
JOIN songs
ON t.song_id = songs.song_id
JOIN artists
ON t.artist_id = artists.artist_id
ORDER BY time DESC
LIMIT 5;
```

|title|name|time|
|:--|:--|:--|
|You're The One|Dwight Yoakam|37|
|I CAN'T GET STARTED|Ron Carter|9|
|Catch You Baby (Steve Pitron & Max Sanna Radio Edit)|Lonnie Gordon|9|
|Nothin' On You [feat. Bruno Mars] (Album Version)|B.o.B|8|
|Hey Daddy (Daddy's Home)|Usher|6|

### Who are the top 5 active users?

```sql
SELECT DISTINCT
first_name,
last_name,
t.time
FROM
(SELECT
user_id, COUNT(songplay_id) AS time
FROM songplays
GROUP BY user_id) t
JOIN users ON t.user_id = users.user_id
ORDER BY t.time DESC
LIMIT 5;
```

|first_name|last_name|time|
|:--|:--|:--|
|Chloe|Cuevas|42|
|Kate|Harrell|32|
|Tegan|Levine|31|
|Aleena|Kirby|21|
|Jacob|Klein|18|

## License

This project is licensed under the MIT License.